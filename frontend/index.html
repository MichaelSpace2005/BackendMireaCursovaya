<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Evolution Tree - Game Mechanics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="max-w-6xl mx-auto p-6 space-y-6">
        <header class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold">Evolution Tree</h1>
                <p class="text-gray-300">Добавляйте и удаляйте механики, просматривайте дерево</p>
            </div>
            <button id="reloadBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Обновить</button>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <section class="lg:col-span-1 bg-gray-800 rounded-lg p-4 space-y-4 shadow">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold">Механики</h2>
                    <span id="mechanicsCount" class="text-sm text-gray-400"></span>
                </div>
                <div id="mechanicsList" class="space-y-3 max-h-[70vh] overflow-y-auto pr-1"></div>
            </section>

            <section class="lg:col-span-2 space-y-4">
                <div class="bg-gray-800 rounded-lg p-4 shadow space-y-3">
                    <h2 class="text-lg font-semibold">Добавить механику</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <input id="nameInput" class="px-3 py-2 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none" placeholder="Название" />
                        <input id="yearInput" type="number" class="px-3 py-2 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none" placeholder="Год" />
                        <input id="descInput" class="px-3 py-2 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none md:col-span-1" placeholder="Описание" />
                    </div>
                    <div class="flex gap-2">
                        <button id="addBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">Сохранить</button>
                        <span id="status" class="text-sm text-gray-400"></span>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-lg p-4 shadow space-y-3">
                    <h2 class="text-lg font-semibold">Связи между механиками</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <input id="fromInput" type="number" class="px-3 py-2 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none" placeholder="ID источника" />
                        <input id="toInput" type="number" class="px-3 py-2 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none" placeholder="ID приемника" />
                        <select id="typeSelect" class="px-3 py-2 rounded bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none">
                            <option value="evolution">Эволюция</option>
                            <option value="inspired_by">Вдохновлено</option>
                            <option value="variant">Вариация</option>
                        </select>
                    </div>
                    <div class="flex gap-2">
                        <button id="addLinkBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Сохранить связь</button>
                        <span id="linkStatus" class="text-sm text-gray-400"></span>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-lg p-4 shadow">
                    <h2 class="text-lg font-semibold mb-2">Дерево эволюции</h2>
                    <div id="treeTitle" class="text-gray-200 font-medium mb-2"></div>
                    <div id="treeView" class="bg-gray-900 rounded-lg p-4 min-h-[300px] text-gray-100"></div>
                </div>

                <div class="bg-gray-800 rounded-lg p-4 shadow space-y-2">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-semibold">Общий граф всех механик</h2>
                        <span id="graphStatus" class="text-sm text-gray-400"></span>
                    </div>
                    <div class="bg-gray-900 rounded-lg border border-gray-700" style="height: 520px;">
                        <svg id="graphSvg" class="w-full h-full"></svg>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        const API_BASE = (() => {
            // If frontend served on host:3000 -> target host:8000, otherwise fallback to localhost:8000
            const { origin } = window.location
            if (origin.includes(':3000')) return origin.replace(':3000', ':8000')
            return 'http://localhost:8000'
        })()
        const API = `${API_BASE}/api/v1`
        const mechanicsList = document.getElementById('mechanicsList')
        const mechanicsCount = document.getElementById('mechanicsCount')
        const treeView = document.getElementById('treeView')
        const treeTitle = document.getElementById('treeTitle')
        const statusEl = document.getElementById('status')
        const linkStatusEl = document.getElementById('linkStatus')
        const graphStatusEl = document.getElementById('graphStatus')
        const graphSvg = document.getElementById('graphSvg')

        const nameInput = document.getElementById('nameInput')
        const yearInput = document.getElementById('yearInput')
        const descInput = document.getElementById('descInput')
        const fromInput = document.getElementById('fromInput')
        const toInput = document.getElementById('toInput')
        const typeSelect = document.getElementById('typeSelect')

        let mechanics = []
        let links = []
        let selectedId = null

        function setStatus(msg, isError=false) {
            statusEl.textContent = msg || ''
            statusEl.className = 'text-sm ' + (isError ? 'text-red-400' : 'text-gray-400')
        }

        function setLinkStatus(msg, isError=false) {
            linkStatusEl.textContent = msg || ''
            linkStatusEl.className = 'text-sm ' + (isError ? 'text-red-400' : 'text-gray-400')
        }

        async function fetchMechanics() {
            setStatus('Загружаю...')
            graphStatusEl.textContent = 'Обновляю граф...'
            try {
                const [mechRes, linkRes] = await Promise.all([
                    fetch(`${API}/mechanics/`),
                    fetch(`${API}/mechanics/links`)
                ])
                if (!mechRes.ok) throw new Error(`Mechanics HTTP ${mechRes.status}`)
                mechanics = await mechRes.json()
                if (!linkRes.ok) throw new Error(`Links HTTP ${linkRes.status}`)
                links = await linkRes.json()
                renderMechanics()
                renderGraph()
                setStatus('')
                graphStatusEl.textContent = ''
            } catch (e) {
                setStatus('Ошибка загрузки механик', true)
                graphStatusEl.textContent = 'Граф не обновлён'
                console.error(e)
            }
        }

        function renderMechanics() {
            mechanicsList.innerHTML = ''
            mechanicsCount.textContent = mechanics.length ? `${mechanics.length} шт.` : ''
            mechanics.forEach(m => {
                const card = document.createElement('div')
                card.className = `rounded-lg border ${m.id === selectedId ? 'border-yellow-400' : 'border-gray-700'} bg-gradient-to-br from-blue-900 to-blue-700 p-3 cursor-pointer hover:border-blue-300`;
                card.innerHTML = `
                    <div class="flex justify-between items-start gap-2">
                        <div>
                            <div class="text-white font-semibold text-lg">${m.name}</div>
                            <div class="text-xs text-blue-200">ID: ${m.id}</div>
                            <div class="text-sm text-blue-100">${m.description || ''}</div>
                            <div class="text-xs text-blue-50 mt-1">Year: ${m.year || ''}</div>
                        </div>
                        <button data-id="${m.id}" class="deleteBtn text-red-300 hover:text-red-200 text-sm">Удалить</button>
                    </div>
                `
                card.addEventListener('click', (e) => {
                    if (e.target.classList.contains('deleteBtn')) return
                    selectedId = m.id
                    renderMechanics()
                    loadTree(m.id, m.name)
                    renderGraph()
                })
                card.querySelector('.deleteBtn').addEventListener('click', async (e) => {
                    e.stopPropagation()
                    await deleteMechanic(m.id)
                })
                mechanicsList.appendChild(card)
            })
        }

        async function loadTree(id, name) {
            treeTitle.textContent = name || ''
            treeView.innerHTML = 'Загрузка...'
            try {
                const res = await fetch(`${API}/mechanics/${id}/tree`)
                if (!res.ok) throw new Error(`HTTP ${res.status}`)
                const tree = await res.json()
                treeView.innerHTML = ''
                const ul = document.createElement('ul')
                ul.className = 'space-y-2'
                renderTreeNode(tree, ul)
                treeView.appendChild(ul)
            } catch (e) {
                treeView.textContent = 'Не удалось получить дерево'
                console.error(e)
            }
        }

        function renderTreeNode(node, container) {
            const m = node.mechanic || node
            const li = document.createElement('li')
            li.innerHTML = `
                <div class="bg-gray-700 border border-gray-600 rounded px-3 py-2">
                    <div class="text-sm font-semibold">${m.name} <span class="text-[10px] text-gray-300">(ID: ${m.id})</span></div>
                    <div class="text-xs text-gray-300">${m.description || ''}</div>
                    <div class="text-xs text-gray-400">Year: ${m.year || ''}</div>
                </div>
            `
            container.appendChild(li)
            const children = node.children || []
            if (children.length) {
                const innerUl = document.createElement('ul')
                innerUl.className = 'ml-4 border-l border-gray-600 pl-3 space-y-2 mt-2'
                children.forEach(child => renderTreeNode(child, innerUl))
                container.appendChild(innerUl)
            }
        }

        async function addMechanic() {
            const name = nameInput.value.trim()
            const year = parseInt(yearInput.value) || null
            const description = descInput.value.trim()
            if (!name) {
                setStatus('Введите название', true)
                return
            }
            try {
                const res = await fetch(`${API}/mechanics/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, description, year })
                })
                if (!res.ok) throw new Error(`HTTP ${res.status}`)
                nameInput.value = ''
                yearInput.value = ''
                descInput.value = ''
                await fetchMechanics()
                setStatus('Сохранено')
            } catch (e) {
                setStatus('Не удалось сохранить', true)
                console.error(e)
            }
        }

        async function deleteMechanic(id) {
            if (!confirm('Удалить механику?')) return
            try {
                const res = await fetch(`${API}/mechanics/${id}`, { method: 'DELETE' })
                if (!res.ok) throw new Error(`HTTP ${res.status}`)
                if (selectedId === id) {
                    selectedId = null
                    treeView.innerHTML = ''
                    treeTitle.textContent = ''
                }
                await fetchMechanics()
                setStatus('Удалено')
            } catch (e) {
                setStatus('Не удалось удалить', true)
                console.error(e)
            }
        }

        async function addLink() {
            const from_id = parseInt(fromInput.value)
            const to_id = parseInt(toInput.value)
            const type = typeSelect.value
            if (!from_id || !to_id) {
                setLinkStatus('Укажите оба ID', true)
                return
            }
            try {
                const res = await fetch(`${API}/mechanics/links`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ from_id, to_id, type })
                })
                if (!res.ok) {
                    let msg = `HTTP ${res.status}`
                    try {
                        const data = await res.json()
                        if (data.detail) msg = data.detail
                    } catch (_) {}
                    throw new Error(msg)
                }
                fromInput.value = ''
                toInput.value = ''
                setLinkStatus('Связь сохранена')
                await fetchMechanics()
                if (selectedId) {
                    await loadTree(selectedId, mechanics.find(m => m.id === selectedId)?.name)
                }
            } catch (e) {
                setLinkStatus(`Не удалось сохранить связь: ${e.message}`, true)
                console.error(e)
            }
        }

        function renderGraph() {
            if (!graphSvg) return
            const width = graphSvg.clientWidth || 800
            const height = graphSvg.clientHeight || 460
            const svg = d3.select(graphSvg)
            svg.selectAll('*').remove()
            svg.attr('viewBox', `0 0 ${width} ${height}`)

            // Background
            svg.append('rect')
                .attr('width', width)
                .attr('height', height)
                .attr('fill', '#0b1220')

            const layer = svg.append('g')

            // Degree calculation for sizing/coloring
            const degree = new Map()
            links.forEach(l => {
                degree.set(l.from_id, (degree.get(l.from_id) || 0) + 1)
                degree.set(l.to_id, (degree.get(l.to_id) || 0) + 1)
            })

            const nodes = mechanics.map(m => ({
                id: m.id,
                name: m.name,
                description: m.description,
                year: m.year,
                deg: degree.get(m.id) || 0
            }))

            const linkData = links.map(l => ({
                source: l.from_id,
                target: l.to_id,
                type: l.type
            }))

            const nodeColor = d => {
                if (d.deg >= 8) return '#d4a017'
                if (d.deg >= 4) return '#9f7aea'
                return '#6b7280'
            }

            const nodeStroke = d => {
                if (d.deg >= 8) return '#f59e0b'
                if (d.deg >= 4) return '#c084fc'
                return '#94a3b8'
            }

            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(linkData).id(d => d.id).distance(90).strength(0.9))
                .force('charge', d3.forceManyBody().strength(-160))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => {
                    const w = Math.max(110, Math.min(200, 10 + (d.name?.length || 0) * 7))
                    const h = 44
                    return Math.max(w, h) * 0.6
                }))

            const link = layer.append('g')
                .attr('stroke', '#94a3b8')
                .attr('stroke-opacity', 0.45)
                .selectAll('line')
                .data(linkData)
                .enter()
                .append('line')
                .attr('stroke-width', 1.2)

            const node = layer.append('g')
                .selectAll('g')
                .data(nodes)
                .enter()
                .append('g')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))

            const rectWidth = d => Math.max(110, Math.min(200, 10 + (d.name?.length || 0) * 7))
            const rectHeight = 44

            node.append('rect')
                .attr('x', d => -rectWidth(d) / 2)
                .attr('y', -rectHeight / 2)
                .attr('rx', 6)
                .attr('ry', 6)
                .attr('width', d => rectWidth(d))
                .attr('height', rectHeight)
                .attr('fill', nodeColor)
                .attr('stroke', d => d.id === selectedId ? '#ef4444' : nodeStroke(d))
                .attr('stroke-width', d => d.id === selectedId ? 3 : 2)
                .attr('opacity', 0.9)

            node.append('text')
                .text(d => d.name)
                .attr('fill', '#e2e8f0')
                .attr('font-size', 11)
                .attr('font-weight', '700')
                .attr('text-anchor', 'middle')
                .attr('y', -4)
                .attr('pointer-events', 'none')

            node.append('text')
                .text(d => `ID:${d.id}${d.year ? ` · ${d.year}` : ''}`)
                .attr('fill', '#cbd5e1')
                .attr('font-size', 10)
                .attr('text-anchor', 'middle')
                .attr('y', 12)
                .attr('pointer-events', 'none')

            link.append('title').text(d => d.type)
            node.append('title').text(d => `${d.name}\nID: ${d.id}${d.year ? `\nYear: ${d.year}` : ''}`)

            const edgePoint = (a, b) => {
                const dx = b.x - a.x || 0.0001
                const dy = b.y - a.y || 0.0001
                const halfW = rectWidth(a) / 2 + 6
                const halfH = rectHeight / 2 + 6
                const ratioX = Math.abs(dx) / halfW
                const ratioY = Math.abs(dy) / halfH
                if (ratioX > ratioY) {
                    return { x: a.x + Math.sign(dx) * halfW, y: a.y + (dy / Math.abs(dx)) * halfW }
                }
                return { x: a.x + (dx / Math.abs(dy)) * halfH, y: a.y + Math.sign(dy) * halfH }
            }

            simulation.on('tick', () => {
                link
                    .attr('x1', d => edgePoint(d.source, d.target).x)
                    .attr('y1', d => edgePoint(d.source, d.target).y)
                    .attr('x2', d => edgePoint(d.target, d.source).x)
                    .attr('y2', d => edgePoint(d.target, d.source).y)

                node.attr('transform', d => `translate(${d.x},${d.y})`)
            })

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart()
                d.fx = d.x
                d.fy = d.y
            }

            function dragged(event, d) {
                d.fx = event.x
                d.fy = event.y
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0)
                d.fx = null
                d.fy = null
            }

            // Zoom/pan
            svg.call(d3.zoom()
                .scaleExtent([0.4, 2.5])
                .on('zoom', (event) => {
                    layer.attr('transform', event.transform)
                }))
        }

        document.getElementById('addBtn').addEventListener('click', addMechanic)
        document.getElementById('reloadBtn').addEventListener('click', fetchMechanics)
        document.getElementById('addLinkBtn').addEventListener('click', addLink)

        fetchMechanics()
    </script>
</body>
</html>
